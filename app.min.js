const express=require("express"),bodyParser=require("body-parser");var _=require("lodash");const ejs=require("ejs"),mongoose=require("mongoose"),Schema=mongoose.Schema,passport=require("passport"),session=require("express-session"),passportLocalMongoose=require("passport-local-mongoose"),GoogleStrategy=require("passport-google-oauth20").Strategy,findOrCreate=require("mongoose-findorcreate"),flash=require("connect-flash"),https=require("https"),{result:result,functions:functions}=require("lodash"),{log:log}=require("console"),posts=[],app=express();var post=mongoose.createConnection("mongodb+srv://Bharath_xD:Saibharat%40123@cluster0.cgaoktp.mongodb.net/blogDB?retryWrites=true&w=majority"),user=mongoose.createConnection("mongodb+srv://Bharath_xD:Saibharat%40123@cluster0.cgaoktp.mongodb.net/userDB?retryWrites=true&w=majority");app.set("view engine","ejs"),app.use(flash()),app.use(bodyParser.urlencoded({extended:!0})),app.use(express.static("public")),app.use(session({secret:"Secret",resave:!1,saveUninitialized:!1,maxAge:72e5})),app.use(passport.initialize()),app.use(passport.session()),passport.use(new GoogleStrategy({clientID:"160599315944-h6ul8lcq6vb4lhqkl7qv3skmp2r6fhl7.apps.googleusercontent.com",clientSecret:"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",callbackURL:"http://localhost:3000/auth/google/compose"},(e,s,t,r)=>{User.findOrCreate({googleId:t.id,username:t.displayName},(e,s)=>r(e,s))}));const headerStatus=require("./routes/HeaderStatus.js"),authenticate=require("./routes/authenticate.js"),useFlash=require("./routes/flash.js");app.use(authenticate),app.use(headerStatus),app.use(useFlash);const postSchema=new Schema({title:String,author:String,content:String}),userSchema=new Schema({email:String,password:String,googleId:String,username:String});userSchema.plugin(passportLocalMongoose),userSchema.plugin(findOrCreate);const Post=post.model("Post",postSchema),User=user.model("User",userSchema);passport.use(User.createStrategy()),passport.serializeUser((e,s)=>{s(null,e.id)}),passport.deserializeUser((e,s)=>{User.findById(e,(e,t)=>{s(e,t)})}),app.get("/",(e,s)=>{Post.find({},(e,t)=>{s.render("home",{posts:t})})}),app.get("/about",(e,s)=>{s.locals.signinStatus=e.isAuthenticated(),s.render("about")}),app.get("/contact",(e,s)=>{s.render("contact")}),app.get("/register",(e,s)=>{e.isAuthenticated()?s.redirect("/"):s.render("register")}),app.get("/login",(e,s)=>{e.isAuthenticated()?s.redirect("/"):(e.session.message={type:"danger",intro:"Empty Fields",message:"Restart"},s.render("login",{signinStatus:e.isAuthenticated()}))}),app.get("/logout",(e,s)=>{e.logout(e=>{if(e)return next(e);setTimeout(e=>{e||s.redirect("/"),console.log(e)},0)})}),app.get("/compose",(e,s)=>{e.isAuthenticated()?s.render("compose"):s.render("login")}),app.get("/posts/:name",(e,s)=>{const t=e.params.name;Post.findById({_id:t},(e,t)=>{e?console.log("err"):s.render("post",{postTitle:t.title,postContent:t.content,postAuthor:t.author})})}),app.get("/report",(e,s)=>{if(e.isAuthenticated())var t=e.user.username;s.locals.signinStatus=e.isAuthenticated(),s.render("report",{username:t})}),app.post("/register",(e,s)=>{User.register({username:e.body.username},e.body.password,(t,r)=>{t?(e.flash("error",t.message),s.redirect("/register")):passport.authenticate("local")(e,s,e=>{e?console.log(e):s.redirect("/compose")})})}),app.post("/login",(e,s)=>{const t=new User({username:e.body.username,password:e.body.password});e.login(t,t=>{t?console.log(t):passport.authenticate("local",{successFlash:"Welcome!",successRedirect:"/compose",failureFlash:!0,failureRedirect:"/login"})(e,s,e=>{e?console.log(e):s.redirect("/compose")})})}),app.post("/compose",(e,s)=>{const t=new Post({title:e.body.inputTitle,author:e.user.username,content:e.body.textAreaPost});t.save(e=>{e||s.redirect("/")})}),app.post("/report",(e,s)=>{e.body.reportAuthor;Post.findOneAndDelete({author:e.body.reportAuthor},(t,r)=>{e.flash("success","We have recieved your report :D "),s.redirect("report")})}),app.listen(process.env.PORT||3e3,function(){console.log("Express server listening on port %d in %s mode",this.address().port,app.settings.env)});